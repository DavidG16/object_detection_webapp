{% extends "base.html" %} {% block content %}

<div class="container text-center" id="main-container">
    <div>

        <!--uncomment if you want to use getUserMedia to activate webcam -->
        <canvas id="canvasOutput"></canvas>
        <video autoplay="true" id="videoElement"> </video>

         <!-- comment out if you want to use getUserMedia to activate webcam -->
{#         <img src="{{ url_for('object_detection_blueprint.activate_camera') }}" width="100%">#}
    </div>


</div>

 <script async src="https://docs.opencv.org/3.4.0/opencv.js" type="text/javascript"></script>
    <script type="text/javascript">

 /*  uncomment if you want to use getUserMedia to activate webcam  */
/*
    let video = document.querySelector("#videoElement");

    if (navigator.mediaDevices.getUserMedia) {
      navigator.mediaDevices.getUserMedia({ video: true, audio:false})
        .then(function (stream) {
          video.srcObject = stream;

        })
        .catch(function (err0r) {
          console.log("Something went wrong!");
        });
    } */

let socket = io('http://127.0.0.1:8000');

    socket.on('connect', function(){
        console.log("Connected...!", socket.connected)
    });

    const video = document.querySelector("#videoElement");

    video.width = 500;
    video.height = 375; ;

    if (navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: true, audio: false })
        .then(function (stream) {
            video.srcObject = stream;
            video.play();
        })
        .catch(function (err0r) {
            console.log(err0r)
            console.log("Something went wrong!");
        });
    }

    let src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
    let dst = new cv.Mat(video.height, video.width, cv.CV_8UC1);
    let cap = new cv.VideoCapture(video);

    const FPS = 22;

    setInterval(() => {
        cap.read(src);

        let type = "image/png"
        let data = document.getElementById("canvasOutput").toDataURL(type);
        data = data.replace('data:' + type + ';base64,', '');

        socket.emit('image', data);
    }, 10000/FPS);


    socket.on('response_back', function(image){
        const image_id = document.getElementById('image');
        image_id.src = image;
    });


    </script>
{% endblock %}